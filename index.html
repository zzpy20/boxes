<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ğŸ“¦ Storage Boxes Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex" />
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --text:#111; --muted:#666; --line:#e6e8ee; --btn:#111; --btnText:#fff; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      margin:0;padding:16px;background:var(--bg);color:var(--text); }
    header{max-width:1020px;margin:0 auto 14px;}
    h1{margin:0 0 8px;font-size:22px;}
    .sub{color:var(--muted);font-size:13px;margin:0 0 12px;line-height:1.45;}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .pill{font-size:12px;color:#475569;background:#fff;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .btn{padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:13px}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-bottom:12px;}
    input[type="search"]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);outline:none;font-size:15px;background:#fff;}
    .counter{font-size:13px;color:var(--muted);padding:10px 12px;background:#fff;border:1px solid var(--line);border-radius:12px;white-space:nowrap;}
    .grid{max-width:1020px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px;}
    a.card{display:block;text-decoration:none;color:inherit;background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;
      box-shadow:0 1px 3px rgba(0,0,0,.06);transition:transform .05s ease,box-shadow .05s ease;}
    a.card:active{transform:scale(0.99);box-shadow:0 1px 2px rgba(0,0,0,.10);}
    .cover{height:120px;background:#f1f5f9;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:12px;overflow:hidden}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .content{padding:12px;}
    .title{font-weight:800;letter-spacing:.3px;font-size:16px;margin-bottom:6px;}
    .note{color:var(--muted);font-size:13px;line-height:1.35;min-height:34px;white-space:pre-wrap;}
    .tags{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;}
    .tag{font-size:12px;color:#334155;background:#eef2ff;padding:4px 8px;border-radius:999px;border:1px solid #e0e7ff;cursor:pointer;}
    .tag:hover{background:#dbeafe;border-color:#93c5fd;}
    .empty{max-width:1020px;margin:18px auto 0;color:var(--muted);font-size:14px;padding:12px 14px;background:#fff;border:1px dashed var(--line);border-radius:12px;display:none;}
    footer{max-width:1020px;margin:18px auto 0;color:var(--muted);font-size:12px;text-align:center;}
    code{background:#fff;padding:2px 6px;border:1px solid var(--line);border-radius:8px;}
    a.smallLink{color:#334155;text-decoration:none;border-bottom:1px dashed #cbd5e1;font-size:13px}
  </style>
</head>
<body>
<header>
  <h1>ğŸ“¦ Storage Boxes Index / ç®±å­æ€»ç´¢å¼•</h1>
  <div class="topbar">
    <span class="pill" id="authStatus">Auth: unknown</span>
    <button class="btn" id="logoutBtn">é€€å‡º/æ¸…é™¤æœ¬æœºæˆæƒ</button>
    <a class="smallLink" href="./admin.html">Adminï¼ˆç¼–è¾‘ boxes.jsonï¼‰</a>
  </div>
  <p class="sub">
    GitHub åªå­˜ <code>key</code>ï¼ˆä¸å­˜ URL / æ–‡ä»¶ï¼‰ã€‚çœŸå® URL åœ¨ Cloudflare KVï¼ˆç§æœ‰ï¼‰ï¼›æ–‡ä»¶åœ¨ Cloudflare R2ï¼ˆç§æœ‰ï¼‰ã€‚<br>
    è®¿é—®ç®±å­éœ€è¦å£ä»¤ï¼›é¦–æ¬¡è¾“å…¥åä¼šè®°ä½æœ¬æœºï¼ˆlocalStorageï¼‰ã€‚ğŸ’¡ å¯ç‚¹å‡»æ ‡ç­¾ç­›é€‰ã€‚
  </p>
  <div class="toolbar">
    <input id="q" type="search" placeholder="æœç´¢ï¼šBOX-23 / cables / å†¬å­£ / kids â€¦" autocomplete="off" />
    <div class="counter" id="counter">Loadingâ€¦</div>
  </div>
</header>

<div class="grid" id="grid"></div>
<div class="empty" id="empty">æ²¡æœ‰åŒ¹é…ç»“æœã€‚</div>
<footer>GitHub Pages Â· zzpy20 Â· <span id="stamp"></span></footer>

<script>
  const TOKEN_STORAGE_KEY="boxes_auth_token";
  const statusEl=document.getElementById("authStatus");
  function getTok(){ try{return (localStorage.getItem(TOKEN_STORAGE_KEY)||"").trim();}catch{return"";} }
  function setStatus(){ statusEl.textContent = getTok() ? "Auth: saved on this device âœ…" : "Auth: not set âŒ"; }
  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    try{ localStorage.removeItem(TOKEN_STORAGE_KEY); }catch{}
    setStatus();
    alert("å·²æ¸…é™¤æœ¬æœºæˆæƒã€‚ä¸‹æ¬¡æ‰“å¼€ç®±å­ä¼šå†æ¬¡è¦æ±‚è¾“å…¥å£ä»¤ã€‚");
  });
  setStatus();

  const grid=document.getElementById("grid"),
        q=document.getElementById("q"),
        counter=document.getElementById("counter"),
        empty=document.getElementById("empty");

  document.getElementById("stamp").textContent=new Date().toISOString().slice(0,10);

  const pad2=n=>String(n).padStart(2,"0");
  const normalize=s=>(s||"").toString().trim().toLowerCase();

  const WORKER_BASE = "https://box-redirect.ausz.workers.dev/"; // must end with '/'
  function baseUrl(){ return WORKER_BASE.endsWith("/") ? WORKER_BASE : (WORKER_BASE + "/"); }
  function mediaListUrl(boxId, token){
    const u = new URL(baseUrl() + `media/box-${boxId}/list`);
    u.searchParams.set("t", token);
    return u.toString();
  }
  function mediaFileUrl(boxId, filename, token){
    const u = new URL(baseUrl() + `media/box-${boxId}/${encodeURIComponent(filename)}`);
    u.searchParams.set("t", token);
    return u.toString();
  }
  function isImage(name){
    const ext = (name||"").split(".").pop().toLowerCase();
    return ["jpg","jpeg","png","gif","webp","heic","avif"].includes(ext);
  }

  async function loadCoverForCard(card, token){
    const boxId = card.dataset.boxid;
    const cover = card.querySelector(".cover");
    if(!boxId || !cover || cover.dataset.loaded) return;
    cover.dataset.loaded = "1";
    try{
      const res = await fetch(mediaListUrl(boxId, token), { cache:"no-store" });
      if(!res.ok) { cover.textContent="æ— å°é¢"; return; }
      const arr = await res.json();
      const first = (Array.isArray(arr) ? arr : []).map(x=>x.name).find(isImage);
      if(!first){ cover.textContent="æ— å°é¢"; return; }
      const img = new Image();
      img.loading = "lazy";
      img.src = mediaFileUrl(boxId, first, token);
      img.alt = `BOX-${boxId} cover`;
      cover.textContent = "";
      cover.appendChild(img);
    }catch(e){
      cover.textContent="å°é¢åŠ è½½å¤±è´¥";
    }
  }

  function setupCoverLazyLoader(){
    const token = getTok();
    if(!token) return;
    const cards = [...document.querySelectorAll("a.card")];
    const queue = [];
    let running = 0;
    const MAX = 4;

    const pump = ()=>{
      while(running < MAX && queue.length){
        const card = queue.shift();
        running++;
        loadCoverForCard(card, token).finally(()=>{ running--; pump(); });
      }
    };

    const io = new IntersectionObserver((entries)=>{
      for(const en of entries){
        if(en.isIntersecting){
          io.unobserve(en.target);
          queue.push(en.target);
        }
      }
      pump();
    }, { rootMargin: "200px" });

    cards.forEach(c=>io.observe(c));
  }

  const coerceTags=tags=>{
    if(Array.isArray(tags)) return tags.map(t=>String(t).trim()).filter(Boolean);
    if(typeof tags==="string") return tags.split(/[;,]/g).flatMap(p=>p.split(/\s+/g)).map(t=>t.trim()).filter(Boolean);
    return [];
  };

  function render(list){
    grid.innerHTML="";
    list.forEach(b=>grid.appendChild(makeCard(b)));
    counter.textContent=`${list.length} boxes`;
    empty.style.display=list.length?"none":"block";
  }

  function applyFilter(){
    const term=normalize(q.value);
    const cards=[...grid.querySelectorAll("a.card")];
    if(!term){
      cards.forEach(c=>c.style.display="");
      counter.textContent=`${cards.length} boxes`;
      empty.style.display="none";
      return;
    }
    let shown=0;
    for(const card of cards){
      const ok=card.dataset.search.includes(term);
      card.style.display=ok?"":"none";
      if(ok) shown++;
    }
    counter.textContent=`${shown} / ${cards.length}`;
    empty.style.display=shown?"none":"block";
  }
  q.addEventListener("input", applyFilter);

  function filterByTag(tag){
    q.value = tag;
    applyFilter();
    q.focus();
  }

  function makeCard(box){
    const a=document.createElement("a");
    a.className="card";
    a.href=`box-${box.id}/`;
    a.dataset.boxid = box.id;

    const cover=document.createElement("div");
    cover.className="cover";
    cover.textContent="å°é¢ï¼ˆéœ€å·²ç™»å½•ï¼‰";

    const c=document.createElement("div");
    c.className="content";

    const t=document.createElement("div");
    t.className="title";
    t.textContent=`BOX-${box.id}`;

    const note=document.createElement("div");
    note.className="note";
    note.textContent=box.note||"";

    const tagsWrap=document.createElement("div");
    tagsWrap.className="tags";

    (box.tags||[]).forEach(tag=>{
      const s=document.createElement("span");
      s.className="tag";
      s.textContent=tag;
      s.title=`ç­›é€‰æ ‡ç­¾ï¼š${tag}`;
      s.addEventListener("click",(e)=>{
        e.preventDefault();
        e.stopPropagation();
        filterByTag(tag);
      });
      tagsWrap.appendChild(s);
    });

    c.appendChild(t);
    c.appendChild(note);
    if((box.tags||[]).length) c.appendChild(tagsWrap);
    a.appendChild(cover);
    a.appendChild(c);

    a.dataset.search=[`box-${box.id}`,box.id,box.key||"",box.note||"", (box.tags||[]).join(" ")].join(" ").toLowerCase();
    return a;
  }

  async function loadBoxes(){
    const res=await fetch("boxes.json",{cache:"no-store"});
    if(!res.ok) throw new Error("boxes.json not found");
    const data=await res.json();
    const boxes=Array.isArray(data.boxes)?data.boxes:[];
    return boxes
      .map(r=>({
        id:pad2(parseInt(r.id,10)),
        key:(r.key||"").trim(),
        note:(r.note||""),
        tags:coerceTags(r.tags)
      }))
      .sort((a,b)=>parseInt(a.id,10)-parseInt(b.id,10));
  }

  (async()=>{
    try{ render(await loadBoxes()); setupCoverLazyLoader(); }
    catch(e){
      const fb=[];
      for(let i=1;i<=50;i++) fb.push({id:pad2(i),key:"",note:"",tags:[]});
      render(fb); setupCoverLazyLoader();
    }
  })();
</script>
</body>
</html>
